<script>
  $("body").addClass("view-chapter");
</script>
{{!-- sectionchaptertruyen --}}
<section class="section-chapter-truyen">
  <div class="container">
    <div class="row text-center">
      <div class="col-md-12 col-noi-dung">
        <div class="top">
          <ul class="breadcrumb" itemscope="" itemtype="http://schema.org/BreadcrumbList">
            <li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a href="/"
                class="itemcrumb" itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">Trang
                  chủ</span></a>
              <meta itemprop="position" content="1">
            </li>
            <li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a href="/tim-truyen"
                class="itemcrumb" itemprop="item" itemtype="http://schema.org/Thing"><span itemprop="name">Thể
                  loại</span></a>
              <meta itemprop="position" content="2">
              <input type="hidden" class="type" value="{{nameTruyen._id}}" id="hidden-id-truyen">
            </li>
            <li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a
                href="/truyen-tranh/{{nameTruyen.slug_truyen}}" class="itemcrumb" itemprop="item"
                itemtype="http://schema.org/Thing">
                <span itemprop="name">{{nameTruyen.ten_truyen}}</span>
                <input type="hidden" value="{{nameTruyen.slug_truyen}}" id="hidden-name-truyen">
              </a>
              <meta itemprop="position" content="3">
            </li>
            <li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a
                href="/truyen-tranh/{{nameTruyen.slug_truyen}}/chap-{{chapTruyen.ten_chuong}}/{{chapTruyen._id}}"
                class="itemcrumb active" itemprop="item" itemtype="http://schema.org/Thing"><span
                  itemprop="name">Chapter {{chapTruyen.ten_chuong}}</span></a>
              <meta itemprop="position" content="4">
            </li>
          </ul>
          <h1 class="txt-primary"><a href="/truyen-tranh/{{nameTruyen.slug_truyen}}">{{nameTruyen.ten_truyen}}</a>
            <span>- Chapter-{{chapTruyen.ten_chuong}}</span></h1>
        </div>
        <div class="reading-control">
          <span class="chapter-id hidden" data-id="{{chapTruyen._id}}" data-suffix=""></span>
          <div class="mb-10">
            <span class="chapter-alert"> Nếu không xem được truyện vui lòng đổi "SERVER ẢNH" bên dưới</span>
            <div class="mt-10">
              <div class="row">
                <a rel="nofollow" href="#" data-server="1"
                  class="loadchapter col-md-2 col-4 btn btn-primary btn-success">Server CDN</a>
                <a rel="nofollow" href="#" data-server="2" class="loadchapter col-md-2 col-4 btn btn-primary">Server
                  GG</a>
                <a rel="nofollow" href="#" data-server="3" class="loadchapter col-md-2 col-4 btn btn-primary">Server
                  EU</a>
                <a rel="nofollow" href="#" data-server="4" class="loadchapter col-md-2 col-4 btn btn-primary"><i
                    class="fa fa-diamond"></i> Server VN</a>
                <a rel="nofollow" href="#" data-server="5" class="loadchapter col-md-2 col-4 btn btn-primary"><i
                    class="fa fa-diamond"></i> Server VN 2</a>
                <a rel="nofollow" href="#" data-server="6" class="loadchapter col-md-2 col-4 btn btn-primary"><i
                    class="fa fa-diamond"></i> Server VN 3</a>
              </div>
            </div>
          </div>

          <div class="mb-10">
            <a rel="nofollow" href="#" class="alertError btn btn-warning" data-toggle="modal" data-target="#myModal"><i
                class="fa fa-exclamation-triangle"></i> Báo lỗi</a>
            <!-- Modal -->
            <div id="myModal" class="modal fade" role="dialog">
              <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"><b>BÁO LỖI TRUYỆN</b></h4>
                  </div>
                  <div class="modal-body">
                    <p>Bạn muốn báo lỗi chương này ? Hãy nói cho bọn mình biết chương này bị lỗi gì vào dưới đây nhé ?
                    </p>
                    <div class="form-horizontal">
                      <div class="form-group error-content">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                          <form id="myForm" method="post">
                            <input id="errorField" name="errorField" type="text" class="form-control" maxlength="255"
                              placeholder="Mô tả lỗi">
                          </form>
                        </div>
                      </div>
                      <p>
                        <button id="myFormSubmit" href="#" class="btn btn-focus mrb5 btn-send-report btn-bao-loi"
                          type="submit">Gửi đi</button>
                      </p>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                  </div>
                </div>

              </div>
            </div>
          </div>
          <div class="chapter-nav" style="z-index: auto; position: static; top: auto;">
            <a class="home changeserver" href="#" title="Đổi server"><i class="fa fa-refresh"></i></a>
            <a href="#" class="prev-link"><i class="fas fa-arrow-left"></i></a>
            <select id="id-Select-chapter" class="select-chapter"></select>
            <a href="#" class="next-link"><i class="fas fa-arrow-right"></i></a>
            <a class="follow-link btn btn-success" href="#" data-id="4446"><i class="fa fa-heart"></i>
              <span>Theo dõi</span></a></div>
          <div></div>
        </div>
        <div class="hidden-control-mobile" id="style-3">
          <a href="/" class="hidden-home-mobile"><i class="fa fa-home"></i></a>
          <a href="#" class="hidden-list-chap"><i class="fa fa-list"></i></a>
          <a href="#" class="change-server-mobile"><i class="fa fa-refresh"></i></a>
          <div class="div-chap">
            <a href="#" class="hidden-prev-chapter prev-link"><i class="fas fa-chevron-left"></i></a>
            <select id="hidden-select-chapter">

            </select>
            <a href="#" class="hidden-next-chapter next-link"><i class="fa fa-chevron-right"></i></a>
          </div>
          <a href="javascript:;" onclick="#" class="alertError btn btn-warning" data-toggle="modal"
            data-target="#myModal">Báo lỗi</a>
        </div>
        <div class="image-truyen" id="content-image-truyen">
          {{#each chapTruyen.server_truyen}}
          <img id="image-truyen-{{@index}}" data-cdn="{{this.sv_cdn}}" data-src="{{this.sv_original}}"
            src="https://icon-library.net/images/spinner-icon-gif/spinner-icon-gif-10.jpg"
            class="lazy-hinh img-truyen img-fluid">
          {{/each}}
        </div>
        <div id="control-list-button">
          <a href="/truyen-tranh/{{nameTruyen.slug_truyen}}" class="list-button"><i class="fas fa-list"></i> List
            chap</a>
        </div>
        <div id="control-home-button">
          <a href="/" class="home-button"><i class="fas fa-home"></i>Trang chủ</a>
        </div>
      </div>
    </div>
  </div>


  <script>

    if ($("body").hasClass("view-chapter") && "undefined" != typeof Storage) {
      var c = $(".chapter-id").data("id");
      if (c) {
        if (void 0 !== localStorage["visited-chapters"]) {
          if (-1 == (H = JSON.parse(localStorage["visited-chapters"])).indexOf(c)) {
            if (H.push(c), H.length > 2e3)
              for (var b = 0; b < 1500; b++) H.shift();
            localStorage["visited-chapters"] = JSON.stringify(H)
          }
        }
        else {
          (O = []).push(c), localStorage["visited-chapters"] = JSON.stringify(O);
        }
        var x = $(".breadcrumb li").eq(2).find("a"),
          A = $(".breadcrumb li").eq(3).find("a"),
          k = $('meta[itemprop="image"]').attr("content");
        if (x && A && k) {
          var S = $("#hidden-id-truyen").val();
          j = {
            id: S,
            image: k,
            name: x.find("span").html(),
            url: x.attr("href"),
            chapterName: A.find("span").html(),
            chapterUrl: A.attr("href")
          };
          if (void 0 !== localStorage["visited-comics"]) {
            var H, T = (H = JSON.parse(localStorage["visited-comics"])).map(function (e) {
              return e.id
            }).indexOf(S);
            if (T > -1 && H.splice(T, 1), H.push(j), H.length > 72)
              for (b = 72; b < H.length; b++) H.shift();
            localStorage["visited-comics"] = JSON.stringify(H)
          } else {
            (O = []).push(j), localStorage["visited-comics"] = JSON.stringify(O)
          }
        }
      }
    }

    // server truyện
    var proxy1 = "";
    var proxy2 = 'https://images2-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&gadget=a&no_expand=1&resize_h=0&rewriteMime=image%2F*&url=';
    var proxy3 = 'https://images.weserv.nl/?url=';

    function changeClass(selector, otherSelector) {
      var sel = $(selector);
      otherSelector.forEach(function myFunction(item, index) {
        item.classList.remove("btn-success");
      });
      sel[0].classList.add("btn-success");
    }

    var loadChapter = document.querySelectorAll('a.loadchapter');
    loadChapter.forEach(function myFunction(item, index) {
      item.addEventListener("click", function () {
        changeClass(this, loadChapter);
      });
    });

    // change server desktop
    document.querySelector("a.changeserver").addEventListener("click", function () {
      var btnSuccess = document.querySelector("a.btn-success[data-server]").nextElementSibling;
      if (btnSuccess != null && !btnSuccess.classList.contains("hidden")) {
        changeClass(btnSuccess, loadChapter);
      } else {
        btnSuccessFirst = document.querySelectorAll("a.loadchapter")[0];
        changeClass(btnSuccessFirst, loadChapter);
      }

    })

    // change server mobile
    document.querySelector("a.change-server-mobile").addEventListener("click", function () {
      var btnSuccess = document.querySelector("a.btn-success[data-server]").nextElementSibling;
      if (btnSuccess != null && !btnSuccess.classList.contains("hidden")) {
        changeClass(btnSuccess, loadChapter);
      } else {
        btnSuccessFirst = document.querySelectorAll("a.change-server-mobile")[0];
        changeClass(btnSuccessFirst, loadChapter);
      }

    })

    function loadImageFromServer(dataServer) {
      var selectorTruyen = document.querySelectorAll("img.img-truyen");
      switch (dataServer) {
        case 1:
          selectorTruyen.forEach(function myFunction(item, index) {
            $(item).attr('src', $(item).data("src"));
          });
          break;
        case 2:
          selectorTruyen.forEach(function myFunction(item, index) {
            $(item).attr('src', proxy2 + encodeURIComponent($(item).data("src")));
          });
          break;
        case 3:
          selectorTruyen.forEach(function myFunction(item, index) {
            $(item).attr('src', proxy3 + encodeURIComponent($(item).data("src")));
          });
          break;
        case 4:
          selectorTruyen.forEach(function myFunction(item, index) {
            $(item).attr('src', $(item).data("cdn"));
          });
          break;
        case 5:
          selectorTruyen.forEach(function myFunction(item, index) {
            $(item).attr('src', proxy2 + encodeURIComponent($(item).data("cdn")));
          });
          break;
        case 6:
          selectorTruyen.forEach(function myFunction(item, index) {
            $(item).attr('src', proxy3 + encodeURIComponent($(item).data("cdn")));
          });
          break;
        default:
        // code block
      }
    }
    // event khi add class
    $('.btn-success').attrchange({
      trackValues: true,
      callback: function (event) {
        loadImageFromServer($('.btn-success').data("server"))
      }
    });

    // khi load image truyện bị lỗi
    document.querySelector("img.img-truyen").addEventListener("error", function () {
      document.querySelector("a.changeserver").click();
    });
    //
    $(function () {
      $('#myFormSubmit').click(function (e) {
        e.preventDefault();
        $.post('/truyen-tranh/error/' + $(".chapter-id").data("id"),
          $('#myForm').serialize(),
          function (data, status, xhr) {
            $("#myModal .close").click()
            alert(data);
          });
      });
    });
    $(window).on("load", function () {
      var urlLoadListChap = "/truyen-tranh/" + $("#hidden-id-truyen").val();
      $.post(urlLoadListChap,
        function (data, status, xhr) {
          var returnedData = JSON.parse(data);
          if (returnedData.success == true) {
            $("#id-Select-chapter").empty();
            $("#hidden-select-chapter").empty();
            var listChap = returnedData.listChap;
            listChap.forEach(function myFunction(item, index) {
              var itemSelection = new Option("Chapter " + item.ten_chap, "/truyen-tranh/" + $("#hidden-name-truyen").val() + "/chap-" + item.ten_chap + "/" + item.id_chap);
              var itemSelectionMobile = new Option("Chapter " + item.ten_chap, "/truyen-tranh/" + $("#hidden-name-truyen").val() + "/chap-" + item.ten_chap + "/" + item.id_chap);
              $("#id-Select-chapter").append(itemSelection);
              $("#hidden-select-chapter").append(itemSelectionMobile);
            })
            var pathname = window.location.pathname;
            $('#id-Select-chapter').val(pathname).prop('selected', true);
            $("#hidden-select-chapter").val(pathname).prop('selected', true);

            // set prev next link
            document.querySelector('.reading-control .prev-link').classList.add("disabled");
            document.querySelector('.hidden-control-mobile .prev-link').classList.add("disabled");
            document.querySelector('.reading-control .next-link').classList.add("disabled");
            document.querySelector('.hidden-control-mobile .next-link').classList.add("disabled");

            // desktop select chapter
            var chapSelected = $('#id-Select-chapter option:selected');
            var prevSelect = chapSelected.prev();
            var nextSelect = chapSelected.next();

            // mobile select chapter
            var mobileChapSelected = $('#hidden-select-chapter option:selected');
            var mobilePrevSelect = mobileChapSelected.prev();
            var mobileNextSelect = mobileChapSelected.next();

            // desktop link
            if (prevSelect != null && prevSelect.val() != null) {
              document.querySelector('.reading-control .prev-link').setAttribute("href", prevSelect.val());
              document.querySelector('.reading-control .prev-link').classList.remove("disabled");
            }
            if (nextSelect != null && nextSelect.val() != null) {
              document.querySelector('.reading-control .next-link').setAttribute("href", nextSelect.val());
              document.querySelector('.reading-control .next-link').classList.remove("disabled");
            }
            // mobile link
            if (mobilePrevSelect != null && mobilePrevSelect.val() != null) {
              document.querySelector('.hidden-control-mobile .prev-link').setAttribute("href", mobilePrevSelect.val());
              document.querySelector('.hidden-control-mobile .prev-link').classList.remove("disabled");
            }
            if (mobileNextSelect != null && mobileNextSelect.val() != null) {
              document.querySelector('.hidden-control-mobile .next-link').setAttribute("href", mobileNextSelect.val());
              document.querySelector('.hidden-control-mobile .next-link').classList.remove("disabled");
            }

          }
        }
      )

    });
    // change chapter nav desktop
    $('#id-Select-chapter').on('change', function () {
      window.location.href = this.value;
    });

    // change chapter nav mobile
    $('#hidden-select-chapter').on('change', function () {
      window.location.href = this.value;
    });

  </script>

</section>

{{!-- endsectionchaptertruyen --}}
